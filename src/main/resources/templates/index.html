<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <title>Import-Export Data</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Favicon -->
    <link th:href="@{/img/favicon.ico}" rel="icon">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries -->
    <link th:href="@{/lib/owlcarousel/assets/owl.carousel.min.css}" rel="stylesheet">
    <link th:href="@{/lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css}" rel="stylesheet"/>

    <!-- Bootstrap and Custom CSS -->
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.min.css" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Prevent whole-page scroll */
        }

        .container-xxl {
            display: flex;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .content {
            overflow: auto; /* Add this to make content scrollable */
        }

        .sidebar {
            width: 250px;
            height: 100vh;
            overflow-y: auto; /* Scroll only if sidebar content overflows */
            flex-shrink: 0;
        }

        .content {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
        }

        .navbar {
            position: sticky;
            top: 0;
            z-index: 1030;
        }

        #mainContent {
            overflow-x: auto;
            overflow-y: auto;
            flex-grow: 1;
            padding: 20px;
            min-height: 0;
            white-space: nowrap; /* Important for horizontal scrolling */
        }

        #mainContent > div {
            display: inline-block; /* Ensures it expands horizontally */
            min-width: 100%;
        }

        /* Inline editing styles */
        .editable {
            cursor: pointer;
            position: relative;
        }

        .editable:hover {
            background-color: #f8f9fa;
        }

        .editable:after {
            content: "‚úé";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .editable:hover:after {
            opacity: 1;
        }

        .editing {
            background-color: #fff3cd !important;
        }

        .editable-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .editable-select {
            width: 100%;
            padding: 4px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        /* Spinner styles */
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            pointer-events: none;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #0d6efd;
            border-width: 0.25em;
        }

        .loading-message {
            margin-top: 1rem;
            font-size: 1.2rem;
            color: #0d6efd;
            font-weight: 500;
            text-align: center;
        }

        .d-none {
            display: none !important;
        }

        /* Excel Button Styles */
        .dt-button.buttons-excel {
            background-color: #28a745 !important;
            color: white !important;
            border-color: #28a745 !important;
        }

        .dt-button.buttons-excel:hover {
            background-color: #218838 !important;
            border-color: #1e7e34 !important;
        }
    </style>
</head>

<body>

<!-- Page Wrapper -->
<div class="container-xxl position-relative bg-white d-flex p-0">

    <!-- Sidebar -->
    <div class="sidebar pe-4 pb-3">
        <nav class="navbar bg-light navbar-light d-flex flex-column h-100">
            <div class="d-flex align-items-center ms-4 mb-4">
                <div class="position-relative">
                    <img class="rounded-circle" th:src="@{/img/user.jpg}" alt="" style="width: 40px; height: 40px;">
                    <div class="bg-success rounded-circle border border-2 border-white position-absolute end-0 bottom-0 p-1"></div>
                </div>
                <div class="ms-3">
                    <h6 class="mb-0">John Doe</h6>
                    <span>Admin</span>
                </div>
            </div>
            <div class="navbar-nav w-100 flex-grow-1">
                <a href="#" id="loadLedgerData" class="nav-item nav-link">
                    <i class="fa fa-book me-2"></i>Ledger Data
                </a>
                <a href="#" id="loadTransferData" class="nav-item nav-link">
                    <i class="fa fa-exchange-alt me-2"></i>Transfer Data
                </a>
            </div>
            <div class="navbar-nav w-100">
                <a href="#" id="loadSettings" class="nav-item nav-link">
                    <i class="fa fa-cog me-2"></i>Settings
                </a>
            </div>
        </nav>
    </div>

    <!-- Content Area -->
    <div class="content">

        <!-- Spinner -->
        <div id="spinner" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); z-index: 99999;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem; border-width: 0.25em;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div style="margin-top: 1rem; font-size: 1.2rem; color: #0d6efd; font-weight: 500;">
                    It will take a moment, please wait...
                </div>
            </div>
        </div>

        <!-- Navbar -->
        <nav class="navbar navbar-expand bg-light navbar-light sticky-top px-4 py-0">
            <a th:href="@{/}" class="navbar-brand d-flex d-lg-none me-4">
                <h2 class="text-primary mb-0"><i class="fa fa-hashtag"></i></h2>
            </a>
            <a href="#" class="sidebar-toggler flex-shrink-0">
                <i class="fa fa-bars"></i>
            </a>
            <div class="navbar-nav align-items-center ms-auto">
                <div class="nav-item dropdown">
                    <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                        <img class="rounded-circle me-lg-2" th:src="@{/img/user.jpg}" alt=""
                             style="width: 40px; height: 40px;">
                        <span class="d-none d-lg-inline-flex">John Doe</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end bg-light border-0 rounded-0 rounded-bottom m-0">
                        <a href="#" class="dropdown-item">My Profile</a>
                        <a href="#" class="dropdown-item">Settings</a>
                        <a href="#" class="dropdown-item">Log Out</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div id="mainContent" class="p-4">
            <div id="defaultContent">
                <h3>Welcome to Dashboard</h3>
                <p>This is the default content.</p>
            </div>
            <div id="loadingMessage" class="alert alert-info d-none" role="alert">
                <i class="fas fa-spinner fa-spin me-2"></i>
                It will take a moment, please wait...
            </div>
        </div>

        <!-- Footer -->
        <div class="container-fluid pt-4 px-4">
            <div class="bg-light rounded-top p-4">
                <div class="row">
                    <div class="col-12 col-sm-6 text-center text-sm-start">
                        &copy; <a href="#">Your Site Name</a>, All Right Reserved.
                    </div>
                    <div class="col-12 col-sm-6 text-center text-sm-end">
                        Designed By <a href="https://htmlcodex.com">HTML Codex</a><br>
                        Distributed By <a class="border-bottom" href="https://themewagon.com"
                                          target="_blank">ThemeWagon</a>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
<!-- Scripts -->
<!-- jQuery should always be FIRST -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap JS (bundle includes Popper.js) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<!-- DataTables Core -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- DataTables Buttons -->
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>

<!-- DataTables Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

<!-- Other Libraries -->
<script th:src="@{/lib/chart/chart.min.js}"></script>
<script th:src="@{/lib/easing/easing.min.js}"></script>
<script th:src="@{/lib/waypoints/waypoints.min.js}"></script>
<script th:src="@{/lib/owlcarousel/owl.carousel.min.js}"></script>
<script th:src="@{/lib/tempusdominus/js/moment.min.js}"></script>
<script th:src="@{/lib/tempusdominus/js/moment-timezone.min.js}"></script>
<script th:src="@{/lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js}"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.all.min.js"></script>

<!-- Your Custom JS -->
<script th:src="@{/js/main.js}"></script>

<script>
    $(document).ready(function () {
        // Show loading message
        function showLoading() {
            $('#defaultContent').hide();
            $('#loadingMessage').removeClass('d-none');
        }

        // Hide loading message
        function hideLoading() {
            $('#loadingMessage').addClass('d-none');
            $('#defaultContent').show();
        }

        // Load Ledger Page
        function loadLedgerData() {
            showLoading();

            // Update the URL without reloading the page
            window.history.pushState({}, '', '/ledgers');

            fetch("/ledgers")
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return res.text();
                })
                .then(html => {
                    // Clear existing content and destroy any existing DataTable
                    $('#mainContent').empty();
                    
                    // Add the new HTML content
                    $('#mainContent').html(html);
                    
                    // Wait for the DOM to be updated
                    setTimeout(() => {
                        // Initialize DataTables after content is loaded
                        if ($.fn.DataTable.isDataTable('#ledgerTable')) {
                            $('#ledgerTable').DataTable().destroy();
                        }
                        
                        var table = $('#ledgerTable').DataTable({
                            dom: 'Bfrtip',
                            buttons: [
                                {
                                    extend: 'excelHtml5',
                                    exportOptions: {
                                        columns: ':visible',
                                        modifier: {
                                            search: 'applied',
                                            order: 'applied'
                                        }
                                    }
                                }
                            ],
                            scrollX: true,
                            paging: true,
                            pageLength: 10,
                            bInfo: true,
                            searching: true,
                            autoWidth: false,
                            columnDefs: [
                                { width: "150px", targets: 1 },  // Ledger Name
                                { width: "150px", targets: 3 },  // Group Name
                                { width: "150px", targets: 5 },  // SubGroup Name
                                { width: "200px", targets: 21 },  // Formula
                                { 
                                    targets: [0, 1, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28],
                                    className: 'editable'
                                }
                            ],
                            language: {
                                search: "Search:",
                                paginate: {
                                    first: "First",
                                    last: "Last",
                                    next: "Next",
                                    previous: "Previous"
                                }
                            }
                        });

                        // Move buttons to the export container
                        table.buttons().container().appendTo('#exportButtonsContainer');

                        // Initialize search functionality
                        $('#ledgerNameSearch').on('keyup', function () {
                            table.column(1).search(this.value).draw();
                        });

                        $('#groupNameSearch').on('keyup', function () {
                            table.column(3).search(this.value).draw();
                        });

                        $('#subGroupNameSearch').on('keyup', function () {
                            table.column(5).search(this.value).draw();
                        });

                        $('#apVersionDropdown').on('change', function () {
                            table.column(26).search(this.value).draw();
                        });

                        // Add inline editing functionality
                        $('#ledgerTable').on('click', 'td.editable', function() {
                            var cell = $(this);
                            var column = table.cell(this).index().column;
                            var row = table.cell(this).index().row;
                            var data = table.cell(this).data();
                            
                            cell.addClass('editing');
                            
                            // Create input for all editable columns
                            var input = $('<input type="text" class="editable-input">');
                            input.val(data);

                            cell.html(input);
                            input.focus();

                            // Handle input completion
                            function completeEdit() {
                                var newValue = input.val();
                                cell.removeClass('editing');
                                
                                // Check if value actually changed
                                if (newValue === data) {
                                    // No change, just restore the original value
                                    cell.html(data);
                                    return;
                                }
                                
                                // Log the data being sent
                                var requestData = {
                                    id: table.cell(row, 0).data(),
                                    column: table.column(column).header().textContent,
                                    value: newValue
                                };
                                console.log('Sending update request:', requestData);
                                
                                // Make the AJAX call to update the backend
                                $.ajax({
                                    url: '/api/ledger/update',
                                    method: 'POST',
                                    contentType: 'application/json',
                                    data: JSON.stringify(requestData),
                                    success: function(response) {
                                        console.log('Update response:', response);
                                        if (response.success) {
                                            // Update the cell data only if the backend update was successful
                                            table.cell(cell).data(newValue);
                                            // Show success message
                                            Swal.fire({
                                                icon: 'success',
                                                title: 'Success!',
                                                text: 'Update successful!',
                                                timer: 1500,
                                                showConfirmButton: false
                                            });
                                        } else {
                                            // Revert the change if the backend update failed
                                            table.cell(cell).data(data);
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'Error!',
                                                text: 'Update failed: ' + (response.message || 'Unknown error')
                                            });
                                        }
                                    },
                                    error: function(xhr, status, error) {
                                        console.error('Update error:', {
                                            status: status,
                                            error: error,
                                            response: xhr.responseText
                                        });
                                        // Revert the change if there was an error
                                        table.cell(cell).data(data);
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'Error!',
                                            text: 'Update failed: ' + (xhr.responseJSON?.message || error)
                                        });
                                    }
                                });
                            }

                            // Handle Enter key and blur
                            input.on('keypress', function(e) {
                                if (e.which === 13) {
                                    completeEdit();
                                }
                            });

                            input.on('blur', function() {
                                completeEdit();
                            });
                        });
                    }, 100);
                })
                .catch(error => {
                    $('#mainContent').html('<p class="text-danger">Failed to load Ledger Data: ' + error.message + '</p>');
                })
                .finally(() => {
                    hideLoading();
                });
        }

        // Load Ledger Page on click
        $('#loadLedgerData').on('click', function (e) {
            e.preventDefault();
            loadLedgerData();
        });

        // Load Transfer Page
        $('#loadTransferData').on('click', function (e) {
            e.preventDefault();
            showLoading();

            fetch("/api/config/is-configured")
                .then(res => res.json())
                .then(isConfigured => {
                    if (!isConfigured) {
                        hideLoading();
                        alert("‚ö†Ô∏è Please configure the destination database in Settings before transferring data.");
                        return;
                    }

                    // Load transfer page
                    return fetch("/transfer-page")
                        .then(res => res.text())
                        .then(html => {
                            $('#mainContent').html(html);
                            hideLoading();

                            // Re-bind events on newly loaded content
                            bindTransferButtonHandler();
                            bindResetButtonHandler();
                        });
                })
                .catch(() => {
                    hideLoading();
                    alert("‚ùå Unable to verify DB configuration. Try again.");
                });
        });

        // Load Settings Page
        $('#loadSettings').on('click', function (e) {
            e.preventDefault();
            showLoading();

            const query = window.location.search;
            fetch("/settings" + query)
                .then(res => res.text())
                .then(html => {
                    $('#mainContent').html(html);
                    hideLoading();
                })
                .catch(() => {
                    $('#mainContent').html('<p class="text-danger">Failed to load Settings.</p>');
                    hideLoading();
                });
        });

        // Reset Button Logic (called after transfer page loads)
        function bindResetButtonHandler() {
            $('#resetButton').on('click', function () {
                $('#loadTransferData').click();
            });
        }

        // Transfer Button Logic (called after transfer page loads)
        function bindTransferButtonHandler() {
            $('#transferButton').on('click', function (e) {
                e.preventDefault();

                const selectedId = $('#id').val();
                const $alert = $('#alertBox');
                if (!selectedId) {
                    $alert.removeClass('d-none alert-success').addClass('alert-danger')
                        .text('‚ö†Ô∏è Please select an ID before transferring.');
                    return;
                }

                showLoading();

                fetch('/api/transfer/dynamic-transfer/' + selectedId, {
                    method: 'POST'
                })
                    .then(res => {
                        hideLoading();
                        if (!res.ok) throw new Error("Transfer failed");
                        return res.text();
                    })
                    .then(() => {
                        $alert.removeClass('d-none alert-danger').addClass('alert-success')
                            .text('‚úÖ Data transferred successfully!');

                            // üîΩ Hide alert after 3 seconds
                            setTimeout(() => {
                                $alert.fadeOut('slow', function () {
                                    $alert.addClass('d-none').show(); // Reset visibility and classes
                                });
                            }, 3000);
                    })
                    .catch(error => {
                        hideLoading();
                        $alert.removeClass('d-none alert-success').addClass('alert-danger')
                            .text('‚ùå Error: ' + error.message);
                    });
            });
        }
    });
</script>


</body>
</html>
